<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LogiPay v0.2</title>
    <link rel="stylesheet" type="text/css" href="logiPayStyle.css">
    <script type="text/javascript" src="calendar.js"></script>
    <script type="text/javascript" src="workClasses.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.2/dist/purify.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
</head>

<script>
    var jsPDF;
    window.onload = function() {
        jsPDF = window.jspdf.jsPDF;
    };

    function printDivAsPdf() {
        document.getElementById("clear-btn").style.display = "none"

        document.getElementById("defraiementInputName").style.border = "none";
        document.getElementById("defraiementInputBnk").style.border = "none";

        var doc = new jsPDF('p', 'mm', 'a4');
        var content = document.getElementById("printSpace");

        html2canvas(content, {
            scale: 5, // Increase scale factor for higher resolution
            onclone: function (clonedDoc) {
                clonedDoc.documentElement.style.height = content.offsetHeight + 'px';
            }
        }).then(function (canvas) {
            var imgData = canvas.toDataURL('image/jpeg', 1.0);
            var pdfWidth = doc.internal.pageSize.getWidth();
            var pdfHeight = doc.internal.pageSize.getHeight();
            var contentWidth = canvas.width / 5; // Convert canvas width to mm
            var contentHeight = canvas.height / 5; // Convert canvas height to mm
            var scale = Math.min(pdfWidth / contentWidth, pdfHeight / contentHeight);
            var xOffset = (pdfWidth - contentWidth * scale) / 2;
            var yOffset = (pdfHeight - contentHeight * scale) / 2;

            doc.addImage(imgData, 'JPEG', xOffset, yOffset, contentWidth * scale, contentHeight * scale, undefined, 'FAST');
            doc.save("Défraiement "+ document.getElementById("defraiementInputName").value+" "+ document.getElementById("monthDropDown").innerText +".pdf");
        });

        document.getElementById("clear-btn").style.display = "block"
    }

</script>

<header class="logiPayHeader">


    <h1 class="pageTitle">LogiPay</h1>
    <h1 class="pageSubTitle">Le service de facturation de logsicool Mons</h1>


</header>

<div id="settings">

    <label for="monthDropDown">Sélectionnez un mois:</label>
    <select class="form-select" id="monthDropDown" name="mois">
        <option value="-1" disabled>Choisissez un mois</option>
        <option value="1">Janvier</option>
        <option value="2">Février</option>
        <option value="3">Mars</option>
        <option value="4">Avril</option>
        <option value="5">Mai</option>
        <option value="6">Juin</option>
        <option value="7">Juillet</option>
        <option value="8">Août</option>
        <option value="9">Septembre</option>
        <option value="10">Octobre</option>
        <option value="11">Novembre</option>
        <option value="12">Décembre</option>
    </select>

    <br>
    <br>
    <br>

    <label for="functionDropDown">Fonction:</label>
    <select class="form-select" id="functionDropDown" name="menu">
        <option selected disabled value="0">Choisissez une option</option>
        <option value="professeur">Professeur</option>
        <option value="accueil">Accueil</option>
    </select>

    <label for="levelDropDown">Niveau:</label>
    <select class="form-select" id="levelDropDown" name="niveau">
        <option selected disabled value="-1">Choisissez un niveau</option>
        <option value="junior">Junior</option>
        <option value="medior">Médior</option>
        <option value="senior">Senior</option>
    </select>




</div>

<div id="calendar"></div>

<body>

<div id="workedDaysList">
</div>

<div id="recapDiv">
</div>

<div id="printButtonSelection">
    <h2>Impression PDF</h2>
    <button id="printPDFButtonSimple" class="btn btn-outline-secondary">
        Imprimer le total
    </button>

</div>

<div id="printSpace">
    <span class="container"><img src="logo_logiscool.png" class="payLogiscoolLogo"></span>
    <div class="centered" id="defraiementTitre">FICHE DE DÉFRAIEMENT - VOLONTARIAT</div>
    <div class="centered" id="defraiementMois">MOIS DE : <span id="defraiementMonthName" ></span></div>
    <div class="defraiementMarginLeft">Nom et prénom du volontaire :<input type="text" class="invalid" id="defraiementInputName"> </div>
    <div class="defraiementMarginLeft">Compte bancaire n° : <input type="text" class="invalid" id="defraiementInputBnk"></div>

    <div id="defraiementPayGrid" class="defraiementMarginLeft">

    </div>

    <div class="defraimentSignSpace">
    <div class="">Date et signature:</div>
    <div class="" id="defraiementSignatureDate">06-04-2023</div>
    <div class="" id="signature-pad" >
        <canvas id="signCanvas" class="invalid">

        </canvas>
    </div>
    <button id="clear-btn" class="btn btn-warning">Reset</button>
    </div>

    <div id="defraiementFooter">
        Code It Bryan ! asbl<br>
        RPM : BE0770.479.710<br>
        Banque : BE02 1431 1606 4140<br>
        Rampe Sainte Waudru 8 – 7000 MONS<br>
    </div>

</div>

</body>
<script>




    addRequiredMechanism(document.getElementById("defraiementInputName"))
    addRequiredMechanism(document.getElementById("defraiementInputBnk"))
    addRequiredMechanism(document.getElementById("signCanvas"))

    function recapDivText()
    {

        recapDivToAppend = document.getElementById("recapDiv")
        recapDivToAppend.innerText = ""
        recapDiv = document.createElement("div");
        recapDiv.classList.add("recapDiv")
        recapDiv.innerText = "Heures d'Accueil : " + stats.accueil + " Nombre de Cours : " + stats.cours + " Nombre de Preparations : " + stats.preparations + " Défraiement total : " +stats.total.toFixed(2) + "€"
        recapDivToAppend.append(recapDiv)
    }

    let canvas = document.querySelector('canvas');
    const signaturePad = new SignaturePad(canvas);
    const clearButton = document.getElementById('clear-btn');


    clearButton.addEventListener('click', () => {
        signaturePad.clear();
        updateCanvasClass()
    });


        document.getElementById("printPDFButtonSimple").addEventListener("click", function () {
            const pf = document.getElementById("printSpace")
            pf.className = "A4"
            printDivAsPdf()
        })

    //Handling calendar display
    let levelInput = false;
    let functionInput = false;

    levelInput = (document.getElementById("levelDropDown").value != -1)
    functionInput = (document.getElementById("functionDropDown").value != -1)

    document.getElementById("functionDropDown").addEventListener("change", f=>{
        if(document.getElementById("functionDropDown").value == -1)
        {
            functionInput = false;
        }
        else
        {
            functionInput = true;
        }
        checkCalendarDisplay();
    })

    document.getElementById("levelDropDown").addEventListener("change", f=>{
        if( document.getElementById("levelDropDown").value == -1)
        {
            levelInput = false;
        }
        else
        {
            levelInput = true;
        }

        checkCalendarDisplay();

    })



    function checkCalendarDisplay()
    {
        console.log(functionInput +" "+ levelInput)

        if(levelInput && functionInput)
        {
            document.getElementById("calendar").style.display = "block";
        }
        else{
            document.getElementById("calendar").style.display = "none";
        }
    }

    checkCalendarDisplay()


    function addRequiredMechanism(node)
    {
        node.addEventListener("change",f=>{

            if(node.value == "")
            {
                node.classList.add("invalid")
            }
            else
            {
                node.classList.remove("invalid")
            }
        })
    }

    //
    canvas = document.getElementById("signCanvas");
    const className = "invalid";

    // Check if the canvas is empty
    function isCanvasEmpty() {
        const context = canvas.getContext("2d");
        const imageData = context.getImageData(0, 0, canvas.width, canvas.height).data;

        for (let i = 0; i < imageData.length; i += 4) {
            if (imageData[i] !== 0 || imageData[i + 1] !== 0 || imageData[i + 2] !== 0 || imageData[i + 3] !== 0) {
                return false; // Canvas is not empty
            }
        }

        return true; // Canvas is empty
    }

    // Add or remove the "invalid" class based on canvas content
    function updateCanvasClass() {
        if (isCanvasEmpty()) {
            canvas.classList.add(className); // Add the "invalid" class
        } else {
            canvas.classList.remove(className); // Remove the "invalid" class
        }
    }

    // Listen to canvas events to trigger class update
    canvas.addEventListener("mouseup", updateCanvasClass);
    canvas.addEventListener("touchend", updateCanvasClass);
    //


</script>


</html>

