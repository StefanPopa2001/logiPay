<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LogiPay v0.2</title>
    <link rel="stylesheet" type="text/css" href="logiPayStyle.css">
    <script type="text/javascript" src="calendar.js"></script>
    <script type="text/javascript" src="workClasses.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.2/dist/purify.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
</head>

<script>
    var jsPDF;
    window.onload = function() {
        jsPDF = window.jspdf.jsPDF;
    };

    function printDivAsPdf() {
        var doc = new jsPDF('p', 'pt', 'a4');
        var content = document.getElementById("printSpace");

        html2canvas(content, {
            onclone: function (clonedDoc) {
                // Set the cloned document's height to be the same as the content height
                clonedDoc.documentElement.style.height = content.offsetHeight + 'px';
            }
        }).then(function (canvas) {
            // Calculate the width and height of the PDF based on the content dimensions and DPI
            var contentWidth = canvas.width;
            var contentHeight = canvas.height;
            var pdfWidth = doc.internal.pageSize.getWidth();
            var pdfHeight = doc.internal.pageSize.getHeight();
            var scale = Math.min(pdfWidth / contentWidth, pdfHeight / contentHeight);
            var xOffset = (pdfWidth - contentWidth * scale) / 2;
            var yOffset = (pdfHeight - contentHeight * scale) / 2;

            // Add the canvas to the PDF and save it
            doc.addImage(canvas, 'PNG', xOffset, yOffset, contentWidth * scale, contentHeight * scale);
            doc.save("Défraiement test.pdf");
        });
    }

</script>

<header class="logiPayHeader">

    <script type="text/javascript">



        //Display all the days
        async function displayWorkedDaysRecap(){

            await spreadWork()

            stats = {
                preparations : 0,
                cours: 0,
                accueil : 0,
                total : 0,
            }

            const workedDaysDiv = document.getElementById("workedDaysList");
            workedDaysDiv.innerHTML = "";

            workedDaysArray.forEach(dayOfWork => {

                const dayDiv = document.createElement("div");
                dayDiv.innerText = `${dayOfWork.dayName} ${dayOfWork.dayNumber} ${dayOfWork.month}`;
                workedDaysDiv.appendChild(dayDiv)
                dayDiv.classList.add("workedDayDiv")
                dayOfWork.workArray.forEach(work => {
                    const workDiv = document.createElement("div");
                    workDiv.classList.add("workEntryDiv")
                    workDiv.innerText = `${work.description} (${work.pay}€)`;
                    dayDiv.appendChild(workDiv)

                    if (work.type == "cours")
                    {
                        stats.cours++
                    }
                    else if(work.type == "accueil")
                    {
                        stats.accueil++
                    }
                    else if(work.type == "preparation")
                    {
                        stats.preparations++
                    }

                    stats.total += work.pay



                })

            })

            recapDivToAppend = document.getElementById("recapDiv")
            recapDivToAppend.innerText = ""
            recapDiv = document.createElement("div");
            recapDiv.classList.add("recapDiv")
            recapDiv.innerText = "Heures d'Accueil : "+stats.accueil + " Nombre de Cours : "+stats.cours+" Nombre de Preparations : "+stats.preparations+" Défraiement total : "+stats.total+"€"
            recapDivToAppend.append(recapDiv)


            payGrid= document.getElementById("defraiementPayGrid")
            payGrid.innerHTML =""

            const table = document.createElement('table');
            const headerRow = document.createElement('tr');
            const headers = ['DATE', 'OBJET', 'DEFRAIMENT', 'NOMBRE', 'TOTAL'];

            for (let header of headers) {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            }
            table.appendChild(headerRow);

            let totalWorkCount = 0;
            let totalWorkPay = 0;

            for (let workDay of workedDaysArray) {
                let workCount = {};
                let workPayTotal = {};

                workDay.workArray.forEach(work=>{
                    if(work.description in workCount){
                        workCount[work.description]++;
                        workPayTotal[work.description] += work.pay;
                    }
                    else{
                        workCount[work.description] = 1;
                        workPayTotal[work.description] = work.pay;
                    }
                });

                for(let workDescription in workCount){
                    const row = document.createElement('tr');
                    const dateCell = document.createElement('td');
                    dateCell.textContent = workDay.dayNumber+"/"+workDay.month+"/"+workDay.year;
                    row.appendChild(dateCell);

                    const objectCell = document.createElement('td');
                    objectCell.textContent = workDescription;
                    row.appendChild(objectCell);

                    const defraimentCell = document.createElement('td');
                    defraimentCell.textContent = workPayTotal[workDescription];
                    row.appendChild(defraimentCell);

                    const nombreCell = document.createElement('td');
                    nombreCell.textContent = workCount[workDescription];
                    row.appendChild(nombreCell);

                    const totalCell = document.createElement('td');
                    totalCell.textContent = workPayTotal[workDescription];
                    row.appendChild(totalCell);

                    totalWorkCount += workCount[workDescription];
                    totalWorkPay += workPayTotal[workDescription];

                    table.appendChild(row);
                }
            }

            // Add a final row with the totals
            const totalRow = document.createElement('tr');
            totalRow.appendChild(document.createElement('td')); // Empty cell
            totalRow.appendChild(document.createElement('td')); // Empty cell
            totalRow.appendChild(document.createElement('td')); // Empty cell


            const totalNombreCell = document.createElement('td');
            totalNombreCell.textContent = totalWorkCount;
            totalRow.appendChild(totalNombreCell);

            const grandTotalCell = document.createElement('td');
            grandTotalCell.textContent = totalWorkPay;
            totalRow.appendChild(grandTotalCell);

            table.appendChild(totalRow);


            payGrid.appendChild(table)
        }





    </script>


    <h1 class="pageTitle">LogiPay</h1>
    <h1 class="pageSubTitle">Le service de facturation de logsicool Mons</h1>


</header>

<div id="settings">

    <label for="monthDropDown">Sélectionnez un mois:</label>
    <select class="form-select" id="monthDropDown" name="mois">
        <option selected disabled>Choisissez un mois</option>
        <option value="1">Janvier</option>
        <option value="2">Février</option>
        <option value="3">Mars</option>
        <option value="4">Avril</option>
        <option value="5">Mai</option>
        <option value="6">Juin</option>
        <option value="7">Juillet</option>
        <option value="8">Août</option>
        <option value="9">Septembre</option>
        <option value="10">Octobre</option>
        <option value="11">Novembre</option>
        <option value="12">Décembre</option>
    </select>

    <br>
    <br>
    <br>

    <label for="functionDropDown">Fonction:</label>
    <select class="form-select" id="functionDropDown" name="menu">
        <option selected disabled value="0">Choisissez une option</option>
        <option value="professeur">Professeur</option>
        <option value="accueil">Accueil</option>
    </select>

    <label for="levelDropDown">Niveau:</label>
    <select class="form-select" id="levelDropDown" name="niveau">
        <option selected disabled value="0">Choisissez un niveau</option>
        <option value="junior">Junior</option>
        <option value="medior">Médior</option>
        <option value="senior">Senior</option>
    </select>




</div>

<div id="calendar"></div>

<body>

<div id="workedDaysList">
    <h2>Récapitulatif</h2>
</div>

<div id="recapDiv">
</div>

<div id="printButtonSelection">
    <h2>Impression PDF</h2>
    <button id="printPDFButtonSimple" class="btn btn-outline-secondary">
        Imprimer le total
    </button>

    <button id="printPDFButtonFull" class="btn btn-outline-secondary">
        Imprimer le détails
    </button>
</div>

<div id="printSpace">
    <span class="container"><img src="../images/logo_logiscool.png" class="payLogiscoolLogo"></img></span>
    <div class="centered" id="defraiementTitre">FICHE DE DÉFRAIEMENT - VOLONTARIAT</div>
    <div class="centered" id="defraiementMois">MOIS DE : <span id="defraiementMonthName"></span></div>
    <div class="defraiementMarginLeft">Nom et prénom du volontaire :<input type="text"> </div>
    <div class="defraiementMarginLeft">Compte bancaire n° : <input type="text"></div>

    <div id="defraiementPayGrid" class="defraiementMarginLeft">

    </div>

    <div class="defraimentSignSpace">
    <div class="">Date et signature:</div>
    <div class="" id="defraiementSignatureDate">06-04-2023</div>
    <div class="" id="signature-pad">
        <canvas id="signCanvas"></canvas>
    </div>
    <button id="clear-btn">Clear</button>
    <button id="save-btn">Save</button>
    </div>

</div>

</body>
<script>
    const canvas = document.querySelector('canvas');
    const signaturePad = new SignaturePad(canvas);
    const clearButton = document.getElementById('clear-btn');
    const saveButton = document.getElementById('save-btn');

    clearButton.addEventListener('click', () => {
        signaturePad.clear();
    });

    saveButton.addEventListener('click', () => {
        if (signaturePad.isEmpty()) {
            alert('Please provide a signature first.');
        } else {
            const signatureData = signaturePad.toDataURL();
            // Do something with the signature data, such as send it to a server or save it to local storage.
            console.log(signatureData);
        }
    });


        document.getElementById("printPDFButtonSimple").addEventListener("click", function () {
            const pf = document.getElementById("printSpace")
            pf.className = "A4"
            printDivAsPdf()
        })





</script>


</html>

